# WebApp-msLogin

WebApp-msLogin is a Flask-based app template using Microsoft identity platform to manage user authentication.

![WebApp-msLogin Admin Preview](https://i.ibb.co/3Tj6826/Admin-User-Info-Page.png "WebApp-msLogin Admin Preview")

### Microsoft Sign In
Use of Microsoft's sign-in service requires an Azure subscription.  The app follows the steps outlined in the [Quickstart: Add sign-in with Microsoft to a Python web app](https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-v2-python-webapp) tutorial.

### Flask Extensions
This project uses several Flask extensions including:

* [msal](https://msal-python.readthedocs.io/en/latest/) for Microsoft authentication
* [Blueprints](http://flask.pocoo.org/docs/0.12/blueprints/) for scalability
* [flask_login](https://flask-login.readthedocs.io/en/latest/) for user access management
* [Flask-SQLAlchemy](https://flask-sqlalchemy.palletsprojects.com/en/2.x/) for database interactions
* [flask_migrate](https://flask-migrate.readthedocs.io/en/latest/) for database migration

### User Access
The app supports access roles to manage and control access.  Access roles are defined in the table Roles.  Access is assigned through the Admin page.  Endpoints can be restricted by including a decorator such as

    @requires_access_level("Admin")

### Session App Settings 
The app saves a Javascript object in the web browser's session storage to manage session-specific app settings.  For example, the app uses this appSettings object to reload the Admin page with the last viewed page tab.  Use this example to implement other custom appSettings.

### WebContent
The app implements a database table named WebContent to customize app appearance and content.  The parameters are saved in a dictionary called WebContent which is available to html templates as a Jinja template variable.  The app will use the current parameters when rendering html pages.  Changes to the parameters can be made directly in the database table for on-the-fly customization.  The WebContent parameters used in the app are listed in this csv file: 'WebContent_Example_Settings.csv'.  For example, this setting specifies the color of the top bar: 

    {{webContent['layout']['top-bar-color']}}

### System Mode
The app implements a database table named adminSettings to manage system settings.  For example, the Admin page includes an option to switch the system mode between ops mode and test mode.  The app can be customized to use the system mode status to enable or disable different operations.

![WebApp-msLogin System Mode Preview](https://i.ibb.co/Fqm8fmm/Admin-App-Setup-Page.png "WebApp-msLogin System Mode Preview")

## Installation and Configuration
The following instructions provide the general steps to install and configure the app.  This app runs on http://localhost:5000 and uses SQLite as a development database.  The app will initialize the database with a test account, access roles, and default WebContent values.

### Establish virtual environment in project directory
    python3 -m venv webapp-venv

### Install requirements 
    pip install -r requirements.txt

### Configure environment variables for Microsoft sign in
The app will load environment variables saved in a file named local.env.  Set these environment variables to the values generated by Azure during app registration:

    CLIENT_ID=your-client-id
    CLIENT_SECRET=your-client-secret

### Run the application
    python runApp.py

### Sign in with test account
The test account with email set to test@test is created during app initialization.  Remove the test account if deploying the app to production environments.

    Open http://localhost:5000/test in your web browser

### Sign in with Microsoft account
This option requires adding a valid Microsoft account to the database

    Open http://localhost:5000 in your web browser
    Click the sign in button and sign in with a Microsoft account

### Add additional users and delete test account
Use the Admin page to add individual users or import a CSV file with multiple users.
Use the Admin page to delete the test account to disable access through the test login.

### Datebase upgrades
Note: the app will initilize the database on first use.  Use Flask-Migrate to manage updates by following these steps

    export FLASK_APP=runApp.py (Linux or MacOS)
    set FLASK_APP=runApp.py (Windows)
    flask db upgrade